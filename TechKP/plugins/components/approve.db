from TechKP.database.join_reqs import JoinReqs
from pyrogram import errors, filters, types, Client, enums
from TechKP.config.config import Config
from TechKP.database.db import db

join_db = JoinReqs

@Client.on_chat_join_request((filters.group | filters.channel))
async def auto_approve(client, message: types.ChatJoinRequest):
    if message.chat.id == Config.FORCE_SUB_CHANNEL and join_db().isActive():
        ap_user_id = message.from_user.id
        first_name = message.from_user.first_name
        username = message.from_user.username
        date = message.date
        await join_db().add_user(user_id=ap_user_id, first_name=first_name, username=username, date=date)
    if Config.AUTO_APPROVE_MODE == True:
        if not await db.is_user_exist(message.from_user.id):
            await db.add_user(message.from_user.id, message.from_user.first_name)
        if message.chat.id == Config.FORCE_SUB_CHANNEL:
            return 
        chat = message.chat 
        user = message.from_user  
        await client.approve_chat_join_request(chat_id=chat.id, user_id=user.id)
        text = f"<b> ú·¥á ü ü·¥è {message.from_user.mention} üëã,\n\n è·¥è·¥ú Ä  Ä·¥á«´·¥ú·¥ás·¥õ ·¥õ·¥è ·¥ä·¥è…™…¥ {message.chat.title} …™s ·¥Ä·¥ò·¥ò Ä·¥è·¥†·¥á·¥Ö.\n\n·¥ò·¥è·¥°·¥á Ä·¥á·¥Ö  ô è - @KOPAINGLAY15</b>"
        await client.send_message(chat_id=user.id, text=text)
